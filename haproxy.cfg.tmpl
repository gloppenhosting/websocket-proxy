# Generated by confd {{datetime}}

global
  log 127.0.0.1 local1 notice
  maxconn 4096
  user haproxy
  group haproxy
  daemon
  nbproc 2
  pidfile /var/run/haproxy.pid
  ca-base /etc/ssl
  crt-base /etc/ssl
  ssl-default-bind-ciphers EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
  ssl-default-bind-options no-sslv3 no-tls-tickets
  tune.ssl.default-dh-param 2048

defaults
  log global
  maxconn 4096
  mode http
  # Add x-forwarded-for header.
  option forwardfor
  option http-server-close
  timeout connect 5s
  timeout client 30s
  timeout server 30s
  # Long timeout for WebSocket connections.
  timeout tunnel 1h

frontend asterisk
  # HTTPS
  # Example with CA certificate bundle
  # bind :443 ssl crt cert.pem ca-file bundle.crt
  # Example without CA certification bunch
  rspadd Strict-Transport-Security:\ max-age=31536000;\ includeSubdomains;\ preload
  rspadd X-Frame-Options:\ DENY
  http-response set-header X-Content-Type-Options nosniff
  bind :8089 ssl crt snakeoil.pem ciphers AES128+EECDH:AES128+EDH force-tlsv12 no-sslv3

  default_backend asterisk

frontend galera-cluster
  bind :3306
  default_backend galera-cluster

backend asterisk
  # Tell the backend that this is a secure connection,
  # even though it's getting plain HTTP.
  reqadd X-Forwarded-Proto:\ https

  balance leastconn
  # Check by hitting a page intended for this use.
  option httpchk GET /httpstatus
  timeout check 500ms
  # Wait 500ms between checks.
{{range gets "/haproxy/asterisk/*"}}  server {{base .Key}} {{.Value}}:8089 check inter 500ms
{{end}}

backend galera-cluster
  mode tcp
  balance source
  option tcplog
  option httpchk
{{ range $node_name := gets "/galera/*" }} server {{ base $node_name.Key }} {{ $node_name.Value }}:3306 check port 8000 inter 12000 rise 3 fall 3
{{ end }}

frontend stats
  # HTTPS only.
  bind :1936 ssl crt snakeoil.pem ciphers AES128+EECDH:AES128+EDH force-tlsv12 no-sslv3
  default_backend stats

backend stats
  stats enable
  stats hide-version
  stats realm Haproxy Statistics
  stats uri /
  stats auth admin:password
  stats refresh 5s
